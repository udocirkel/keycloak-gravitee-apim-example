networks:
  coffeehouse:
    driver: bridge

services:

  # Keycloak                            => http://localhost:8080
  # Gravitee API Gateway APIs           => http://localhost:8082
  # Gravitee API Gateway Metrics        => http://localhost:18082
  # Gravitee Management API             => http://localhost:8083
  # Gravitee Management Console (nginx) => http://localhost:8084
  # Gravitee Developer Portal (nginx)   => http://localhost:8085
  # Coffee Ingredient Service           => http://localhost:8087
  # Coffee Menu Service                 => http://localhost:8088
  # Coffee Order Service                => http://localhost:8089
  # Prometheus                          => http://localhost:9090
  # Grafana                             => http://localhost:3000

  ##############################
  ###  AUTHORIZATION SERVER  ###
  ##############################

  keycloak:
    image: udocirkel/kcgravitee-example/keycloak:1.0.0
    restart: always
    environment:
      KC_HOSTNAME: keycloak
      KC_HTTP_PORT: 8080
      KC_DB: dev-mem
      KC_HEALTH_ENABLED: 'true'
      KC_METRICS_ENABLED: 'false'
      KC_LOG_LEVEL: DEBUG
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
    healthcheck:
      # Check nur auf TCP Ebene, da Distroless Image ohne curl, wget
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/8080"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    volumes:
      - ./keycloak/config/realm-coffeehouse.json:/opt/keycloak/data/import/realm-coffeehouse.json:ro
    ports:
      - "8080:8080"
      - "9000:9000"
    networks: [coffeehouse]
    command: ["start-dev", "--import-realm"]

  #################################
  ###  API MANAGEMENT PLATFORM  ###
  #################################

  mongodb:
    image: mongo:7.0
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.adminCommand(\"ping\")' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - ./data/mongodb:/data/db
    networks: [coffeehouse]

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.16.1
    restart: always
    environment:
      - http.host=0.0.0.0
      - transport.host=0.0.0.0
      - xpack.security.enabled=false
      - cluster.name=elasticsearch
      - bootstrap.memory_lock=true
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes:
      - ./data/elastic:/usr/share/elasticsearch/data
    networks: [coffeehouse]

  management_api:
    image: udocirkel/kcgravitee-example/apim-management-api:1.0.0
    restart: always
    depends_on:
      elasticsearch:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?serverSelectionTimeoutMS=5000&connectTimeoutMS=5000&socketTimeoutMS=5000
      - gravitee_analytics_elasticsearch_endpoints_0=http://elasticsearch:9200
      - gravitee_installation_standalone_portal_url=http://localhost:8085
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD-SHELL", "curl -u admin:admin -f http://localhost:8083/management/v2/environments/DEFAULT/apis || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks: [coffeehouse]

  management_ui:
    image: graviteeio/apim-management-ui:latest
    restart: always
    environment:
      - MGMT_API_URL=http://localhost:8084/management/organizations/DEFAULT/environments/DEFAULT/
    networks: [coffeehouse]

  portal_ui:
    image: graviteeio/apim-portal-ui:latest
    restart: always
    depends_on:
      management_api:
        condition: service_healthy
    environment:
      - PORTAL_API_URL=http://localhost:8085/portal/environments/DEFAULT
    networks: [coffeehouse]

  gateway:
    image: udocirkel/kcgravitee-example/apim-gateway:1.0.0
    restart: always
    depends_on:
      mongodb:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      management_api:
        condition: service_healthy
    environment:
      # MongoDB
      - gravitee_management_mongodb_uri=mongodb://mongodb:27017/gravitee?retryWrites=true&w=majority
      - gravitee_mongodb_uri=mongodb://mongodb:27017/gravitee
      - gravitee_ratelimit_mongodb_uri=mongodb://mongodb:27017/gravitee
      # Elasticsearch
      - gravitee_analytics_elasticsearch_endpoints_0=http://elasticsearch:9200
      - gravitee_reporters_elasticsearch_endpoints_0=http://elasticsearch:9200
      # Gateway Binding
      - gravitee_management_url=http://management_api:8083/management
      - gravitee_management_http_url=http://management_api:8083/management/organizations/DEFAULT/environments/DEFAULT/
    ports:
      - "8082:8082"
      - "18082:18082"
    volumes:
      - ./gravitee/config/gravitee.yml:/opt/graviteeio-gateway/config/gravitee.yml:ro
    networks: [coffeehouse]

  nginx_management:
    image: nginx:alpine
    restart: always
    depends_on:
      - management_ui
      - management_api
    ports:
      - "8084:80"
    volumes:
      - ./nginx/config/nginx_management.conf:/etc/nginx/nginx.conf:ro
    networks: [coffeehouse]

  nginx_portal:
    image: nginx:alpine
    restart: always
    depends_on:
      - portal_ui
      - management_api
    ports:
      - "8085:80"
    volumes:
      - ./nginx/config/nginx_portal.conf:/etc/nginx/nginx.conf:ro
    networks: [coffeehouse]

  ####################
  ###  MONITORING  ###
  ####################

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./data/prometheus:/prometheus
    networks: [coffeehouse]

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./grafana/config/datasources:/etc/grafana/provisioning/datasources:ro
    networks: [coffeehouse]

  ##############################
  ###  COFFEEHOUSE SERVICES  ###
  ##############################

  coffee-ingredient-service:
    image: udocirkel/kcgravitee-example/coffee-ingredient-service:1.0.0
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      - JWT_ISSUER_URI=http://keycloak:8080/realms/coffeehouse
      - LOG_LEVEL=DEBUG
    ports:
      - "8087:8080"
    networks: [coffeehouse]

  coffee-menu-service:
    image: udocirkel/kcgravitee-example/coffee-menu-service:1.0.0
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      - JWT_ISSUER_URI=http://keycloak:8080/realms/coffeehouse
      - INGREDIENT_SERVICE_URL=http://coffee-ingredient-service:8080
      - LOG_LEVEL=DEBUG
    ports:
      - "8088:8080"
    networks: [coffeehouse]

  coffee-order-service:
    image: udocirkel/kcgravitee-example/coffee-order-service:1.0.0
    restart: always
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      - JWT_ISSUER_URI=http://keycloak:8080/realms/coffeehouse
      - MENU_SERVICE_URL=http://gateway:8082/coffee-menu-api
      - LOG_LEVEL=DEBUG
    ports:
      - "8089:8080"
    networks: [coffeehouse]
